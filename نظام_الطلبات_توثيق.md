# توثيق نظام إدارة الطلبات

## نظرة عامة
تم إنشاء نظام إدارة طلبات كامل لتطبيق Fillo مع وظائف للمستخدمين والإداريين.

## الملفات المنشأة

### 1. ملفات الهجرة (Migrations)
- **`database/migrations/2026_02_25_180000_add_cancellation_reason_to_orders_table.php`**
  - يضيف حقل `cancellation_reason` (سبب إداري أو عدم استلام الزبون)
  - يضيف حقل `admin_notes` لملاحظات الإدارة

### 2. الكونترولرات

#### كونترولر المستخدمين
- **`app/Http/Controllers/api/v1/customers/OrderController.php`**
  - `index()` - عرض طلبات المستخدم مع فلتر الحالة
  - `show($order_id)` - عرض تفاصيل الطلب
  - `store()` - إنشاء طلب جديد من السلة

#### كونترولر الإدارة
- **`app/Http/Controllers/api/v1/admin/OrderController.php`**
  - `index()` - عرض جميع الطلبات مع البحث والفلاتر
  - `show($order_id)` - عرض تفاصيل الطلب
  - `confirmOrder($order_id)` - الموافقة على طلب معلق
  - `rejectOrder($order_id)` - رفض طلب معلق مع إرجاع كامل المبلغ
  - `shipOrder($order_id)` - تحديد الطلب كمشحون
  - `deliverOrder($order_id)` - تحديد الطلب كموصل
  - `completeOrder($order_id)` - تحديد الطلب كمكتمل
  - `cancelOrder($order_id)` - إلغاء الطلب مع تحديد السبب
  - `refundOrder($order_id)` - إرجاع مبلغ طلب مكتمل

### 3. الإشعارات
جميع الإشعارات موجودة في `app/Notifications/customers/`:
- `OrderConfirmedNotification.php` - يُرسل عند موافقة الإدارة على الطلب
- `OrderRejectedNotification.php` - يُرسل عند رفض الإدارة للطلب
- `OrderShippedNotification.php` - يُرسل عند شحن الطلب
- `OrderDeliveredNotification.php` - يُرسل عند توصيل الطلب
- `OrderCompletedNotification.php` - يُرسل عند إكمال الطلب
- `OrderCancelledNotification.php` - يُرسل عند إلغاء الطلب
- `OrderRefundedNotification.php` - يُرسل عند إرجاع مبلغ الطلب

### 4. سيدر الصلاحيات
- **`database/seeders/OrderPermissionsSeeder.php`**
  - `show-orders` - صلاحية عرض الطلبات
  - `edit-orders` - صلاحية إدارة الطلبات

### 5. ملفات الترجمة المحدثة
تم تحديث ملفات الترجمة العربية والإنجليزية بجميع رسائل الطلبات:
- `resources/lang/ar/responses.php`
- `resources/lang/en/responses.php`

### 6. المسارات المحدثة

#### مسارات المستخدمين (`routes/v1/api-customers.php`)
```php
// Order Routes
Route::get('orders', [OrderController::class, 'index']);
Route::get('orders/{order_id}', [OrderController::class, 'show']);
Route::post('orders', [OrderController::class, 'store']);
```

#### مسارات الإدارة (`routes/v1/api-dashboard.php`)
```php
// Order Routes
Route::get('orders', [OrderController::class, 'index']);
Route::get('orders/{order_id}', [OrderController::class, 'show']);
Route::post('orders/{order_id}/confirm', [OrderController::class, 'confirmOrder']);
Route::post('orders/{order_id}/reject', [OrderController::class, 'rejectOrder']);
Route::post('orders/{order_id}/ship', [OrderController::class, 'shipOrder']);
Route::post('orders/{order_id}/deliver', [OrderController::class, 'deliverOrder']);
Route::post('orders/{order_id}/complete', [OrderController::class, 'completeOrder']);
Route::post('orders/{order_id}/cancel', [OrderController::class, 'cancelOrder']);
Route::post('orders/{order_id}/refund', [OrderController::class, 'refundOrder']);
```

## المميزات المنفذة

### 1. إنشاء طلب للمستخدم
- ✅ التحقق من أن المستخدم لديه `national_address_short_number`
- ✅ تحويل عناصر السلة إلى طلب
- ✅ تطبيق الكوبون إذا تم تقديمه
- ✅ حساب رسوم الشحن من الإعدادات
- ✅ تقليل كميات المنتجات من المخزون
- ✅ إنشاء عناصر الطلب لكل منتج في السلة
- ✅ إفراغ السلة بعد إنشاء الطلب بنجاح
- ✅ إنشاء سجل الدفع
- ✅ توليد رقم طلب فريد (ORD-XXXXX)

### 2. تدفق حالات الطلب
يتبع الطلب هذا التسلسل:
1. **pending** (معلق) - الحالة الأولية عند إنشاء الطلب
2. **confirmed** (مؤكد) - الإدارة توافق على الطلب
3. **shipping** (قيد الشحن) - الطلب يتم شحنه
4. **delivered** (تم التوصيل) - تم توصيل الطلب
5. **completed** (مكتمل) - الطلب منتهي
6. **cancelled** (ملغى) - تم إلغاء الطلب
7. **refunded** (مُرجع) - تم إرجاع مبلغ الطلب بعد الإكمال

### 3. إدارة الطلبات من قبل الإدارة

#### تأكيد الطلب
- تغيير الحالة من `pending` إلى `confirmed`
- إرسال إشعار للمستخدم

#### رفض الطلب
- يعمل فقط على الطلبات `pending`
- إرجاع المنتجات للمخزون
- تحديد الحالة كـ `cancelled` مع السبب `administrative`
- تحديث حالة الدفع إلى `refunded`
- إرسال إشعار للمستخدم

#### شحن الطلب
- تغيير الحالة من `confirmed` إلى `shipping`
- إرسال إشعار للمستخدم

#### توصيل الطلب
- تغيير الحالة من `shipping` إلى `delivered`
- إرسال إشعار للمستخدم

#### إكمال الطلب
- تغيير الحالة من `delivered` إلى `completed`
- إرسال إشعار للمستخدم

#### إلغاء الطلب
- لا يمكن الإلغاء إذا كانت الحالة `cancelled` أو `completed` أو `refunded`
- إرجاع المنتجات للمخزون
- يتطلب سبب الإلغاء:
  - **administrative** (سبب إداري) - إرجاع كامل المبلغ بما فيه الشحن
  - **customer_not_received** (عدم استلام الزبون) - إرجاع المبلغ بدون رسوم الشحن
- تحديث حالة الدفع إلى `refunded`
- إرسال إشعار للمستخدم

#### إرجاع مبلغ الطلب
- يعمل فقط على الطلبات `completed`
- إرجاع المنتجات للمخزون
- تغيير الحالة إلى `refunded`
- تحديث حالة الدفع إلى `refunded`
- إرسال إشعار للمستخدم

### 4. قواعد التحقق
- يجب أن يكون لدى المستخدم `national_address_short_number` لإنشاء طلب
- يجب ألا تكون السلة فارغة
- يجب أن تكون منتجات السلة متاحة ولديها كمية كافية
- الإدارة يمكنها فقط تنفيذ إجراءات بناءً على حالة الطلب الحالية
- لا يمكن إلغاء الطلب إذا كان بالفعل ملغى أو مكتمل أو مُرجع

### 5. الإشعارات
جميع الإشعارات تُرسل باستخدام نفس النمط المستخدم في نظام الحجوزات:
- إشعارات قاعدة البيانات
- إشعارات FCM push
- رسائل ثنائية اللغة (عربي وإنجليزي)

### 6. إدارة المخزون
- يتم تقليل كميات المنتجات عند إنشاء الطلب
- يتم إرجاع كميات المنتجات عند:
  - رفض الطلب
  - إلغاء الطلب
  - إرجاع مبلغ الطلب

## خطوات التثبيت

1. **تشغيل الهجرات:**
```bash
php artisan migrate
```

2. **تشغيل السيدرز:**
```bash
php artisan db:seed --class=OrderPermissionsSeeder
# أو تشغيل جميع السيدرز
php artisan db:seed
```

3. **مسح الكاش:**
```bash
php artisan route:clear
php artisan config:clear
php artisan cache:clear
```

## نقاط API

### نقاط المستخدمين

#### قائمة الطلبات
```
GET /api/v1/customers/orders
Query Parameters:
  - status: pending|confirmed|shipping|delivered|completed|cancelled|refunded|all
```

#### عرض تفاصيل الطلب
```
GET /api/v1/customers/orders/{order_id}
```

#### إنشاء طلب
```
POST /api/v1/customers/orders
Body:
  - customer_address_id: required|exists:customer_addresses,id
  - coupon_code: nullable|string|exists:coupons,code
```

### نقاط الإدارة

#### قائمة الطلبات
```
GET /api/v1/dashboard/orders
Query Parameters:
  - search: string (البحث في رقم الطلب، الهاتف، اسم/بريد/هاتف المستخدم)
  - status: pending|confirmed|shipping|delivered|completed|cancelled|refunded|all
```

#### عرض تفاصيل الطلب
```
GET /api/v1/dashboard/orders/{order_id}
```

#### تأكيد الطلب
```
POST /api/v1/dashboard/orders/{order_id}/confirm
```

#### رفض الطلب
```
POST /api/v1/dashboard/orders/{order_id}/reject
```

#### شحن الطلب
```
POST /api/v1/dashboard/orders/{order_id}/ship
```

#### توصيل الطلب
```
POST /api/v1/dashboard/orders/{order_id}/deliver
```

#### إكمال الطلب
```
POST /api/v1/dashboard/orders/{order_id}/complete
```

#### إلغاء الطلب
```
POST /api/v1/dashboard/orders/{order_id}/cancel
Body:
  - cancellation_reason: required|in:administrative,customer_not_received
  - admin_notes: nullable|string
```

#### إرجاع مبلغ الطلب
```
POST /api/v1/dashboard/orders/{order_id}/refund
```

## ملاحظات

1. **بوابة الدفع**: نظام الدفع جاهز لكنه غير متصل ببوابة دفع حقيقية. يتم إنشاء سجلات الدفع بحالة 'pending'.

2. **منطق الإرجاع**: الإرجاعات تحدث حالة قاعدة البيانات لكنها لا تعالج إرجاع المبالغ فعلياً من خلال بوابة دفع.

3. **الإشعارات**: جميع الإشعارات تتبع نمط الإشعارات الموجود باستخدام `SendNotificationJob`.

4. **الصلاحيات**: المدراء يحتاجون إلى صلاحية `show-orders` لعرض الطلبات و `edit-orders` لإدارتها.

5. **أمان المعاملات**: جميع عمليات قاعدة البيانات تستخدم transactions لضمان سلامة البيانات.

6. **تحويل العملة**: النظام يحترم واجهة تحويل العملة الموجودة لديك لعرض الأسعار.

## رسائل الخطأ

جميع رسائل الخطأ مترجمة بشكل صحيح بالعربية والإنجليزية:
- السلة فارغة
- الرقم المختصر للعنوان الوطني مطلوب
- المنتج غير متاح
- كمية المنتج غير متاحة
- رسائل التحقق من حالة الطلب
- أخطاء الصلاحيات

## نجاح!

نظام إدارة الطلبات الكامل جاهز الآن للاستخدام. جميع المميزات تم تنفيذها وفقاً لمتطلباتك مع التحقق المناسب، الإشعارات، إدارة المخزون، ومنطق الإرجاع.
