# توثيق نظام طلبات إلغاء الطلبات

## نظرة عامة
تم إضافة نظام كامل لطلبات إلغاء الطلبات يسمح للمستخدمين بطلب إلغاء طلباتهم، وللإدارة بمراجعة هذه الطلبات والموافقة عليها أو رفضها.

## الملفات المنشأة

### 1. ملفات الهجرة
- **`database/migrations/2026_02_25_190000_create_order_cancellation_requests_table.php`**
  - ينشئ جدول `order_cancellation_requests`
  - الحقول: order_id, customer_id, customer_reason, status, cancellation_reason, admin_notes, reviewed_by, reviewed_at

### 2. الموديل
- **`app/Models/OrderCancellationRequest.php`**
  - يدير بيانات طلبات الإلغاء
  - علاقات مع Order, Customer, و Admin (المراجع)

### 3. الكونترولرات

#### كونترولر المستخدمين (محدث)
- **`app/Http/Controllers/api/v1/customers/OrderController.php`**
  - `requestCancellation($order_id)` - إنشاء طلب إلغاء
  - `myCancellationRequests()` - عرض طلبات الإلغاء للمستخدم
  - `showCancellationRequest($request_id)` - عرض تفاصيل طلب الإلغاء

#### كونترولر الإدارة (جديد)
- **`app/Http/Controllers/api/v1/admin/OrderCancellationRequestController.php`**
  - `index()` - عرض جميع طلبات الإلغاء مع البحث والفلاتر
  - `show($request_id)` - عرض تفاصيل طلب الإلغاء
  - `approve($request_id)` - الموافقة على طلب الإلغاء
  - `reject($request_id)` - رفض طلب الإلغاء

### 4. الإشعارات
- **`app/Notifications/customers/CancellationRequestApprovedNotification.php`** - يُرسل عند موافقة الإدارة
- **`app/Notifications/customers/CancellationRequestRejectedNotification.php`** - يُرسل عند رفض الإدارة

### 5. سيدر الصلاحيات
- **`database/seeders/OrderCancellationRequestPermissionsSeeder.php`**
  - `show-order-cancellation-requests` - صلاحية عرض طلبات الإلغاء
  - `edit-order-cancellation-requests` - صلاحية إدارة طلبات الإلغاء

### 6. ملفات الترجمة المحدثة
تم تحديث ملفات الترجمة العربية والإنجليزية بجميع رسائل طلبات الإلغاء.

### 7. المسارات المحدثة

#### مسارات المستخدمين
```php
Route::post('orders/{order_id}/request_cancellation', [OrderController::class, 'requestCancellation']);
Route::get('cancellation_requests', [OrderController::class, 'myCancellationRequests']);
Route::get('cancellation_requests/{request_id}', [OrderController::class, 'showCancellationRequest']);
```

#### مسارات الإدارة
```php
Route::get('order_cancellation_requests', [OrderCancellationRequestController::class, 'index']);
Route::get('order_cancellation_requests/{request_id}', [OrderCancellationRequestController::class, 'show']);
Route::post('order_cancellation_requests/{request_id}/approve', [OrderCancellationRequestController::class, 'approve']);
Route::post('order_cancellation_requests/{request_id}/reject', [OrderCancellationRequestController::class, 'reject']);
```

## المميزات المنفذة

### 1. طلب الإلغاء من المستخدم
- ✅ يمكن للمستخدمين طلب إلغاء الطلبات التي ليست:
  - مكتملة (completed)
  - مُرجعة (refunded)
  - ملغاة (cancelled)
- ✅ يمكن للمستخدمين تقديم سبب اختياري لطلب الإلغاء
- ✅ طلب إلغاء معلق واحد فقط مسموح لكل طلب
- ✅ عرض قائمة طلبات الإلغاء الخاصة بهم
- ✅ عرض تفاصيل طلب الإلغاء الفردي

### 2. مراجعة طلبات الإلغاء من الإدارة
- ✅ عرض جميع طلبات الإلغاء مع فلاتر (معلق/موافق عليه/مرفوض/الكل)
- ✅ البحث برقم الطلب، الهاتف، اسم/بريد/هاتف المستخدم
- ✅ عرض تفاصيل الطلب مع معلومات الطلب الكاملة
- ✅ لوحة إحصائيات تعرض الأعداد حسب الحالة

### 3. الموافقة على طلب الإلغاء
عند موافقة الإدارة:
- ✅ يجب تحديد سبب الإلغاء (administrative أو customer_not_received)
- ✅ يمكن إضافة ملاحظات إدارية
- ✅ إرجاع المنتجات للمخزون
- ✅ إلغاء الطلب مع السبب المحدد
- ✅ حساب مبلغ الإرجاع:
  - **administrative** (سبب إداري) → إرجاع كامل المبلغ بما فيه الشحن
  - **customer_not_received** (عدم استلام الزبون) → إرجاع المبلغ بدون رسوم الشحن
- ✅ تحديث حالة الدفع إلى refunded
- ✅ تسجيل المراجع (الإدارة) ووقت المراجعة
- ✅ إرسال إشعار الموافقة للمستخدم

### 4. رفض طلب الإلغاء
عند رفض الإدارة:
- ✅ يمكن إضافة ملاحظات إدارية توضح سبب الرفض
- ✅ تسجيل المراجع (الإدارة) ووقت المراجعة
- ✅ إرسال إشعار الرفض للمستخدم
- ✅ الطلب يستمر بحالته الحالية

### 5. قواعد التحقق
- المستخدم يمكنه طلب الإلغاء فقط إذا لم يكن الطلب مكتمل/مُرجع/ملغى
- لا يمكن إنشاء طلبات إلغاء معلقة مكررة
- فقط الطلبات المعلقة يمكن الموافقة عليها/رفضها
- الإدارة يجب أن تحدد سبب الإلغاء عند الموافقة

## مخطط قاعدة البيانات

### جدول طلبات إلغاء الطلبات
- `id` (المفتاح الأساسي)
- `order_id` (مفتاح خارجي → orders)
- `customer_id` (مفتاح خارجي → customers)
- `customer_reason` (text, nullable) - سبب المستخدم لطلب الإلغاء
- `status` (enum: pending, approved, rejected) - حالة الطلب
- `cancellation_reason` (enum: administrative, customer_not_received, nullable) - السبب المختار من الإدارة
- `admin_notes` (text, nullable) - ملاحظات الإدارة حول القرار
- `reviewed_by` (مفتاح خارجي → users, nullable) - الإدارة التي راجعت
- `reviewed_at` (timestamp, nullable) - متى تمت المراجعة
- `created_at` (timestamp)
- `updated_at` (timestamp)

## نقاط API

### نقاط المستخدمين

#### طلب إلغاء طلب
```
POST /api/v1/customers/orders/{order_id}/request_cancellation
Body:
  - customer_reason: nullable|string|max:500
```

#### قائمة طلبات الإلغاء الخاصة بي
```
GET /api/v1/customers/cancellation_requests
```

#### عرض تفاصيل طلب الإلغاء
```
GET /api/v1/customers/cancellation_requests/{request_id}
```

### نقاط الإدارة

#### قائمة جميع طلبات الإلغاء
```
GET /api/v1/dashboard/order_cancellation_requests
Query Parameters:
  - search: string (البحث في رقم الطلب، الهاتف، اسم/بريد/هاتف المستخدم)
  - status: pending|approved|rejected|all
```

#### عرض تفاصيل طلب الإلغاء
```
GET /api/v1/dashboard/order_cancellation_requests/{request_id}
```

#### الموافقة على طلب الإلغاء
```
POST /api/v1/dashboard/order_cancellation_requests/{request_id}/approve
Body:
  - cancellation_reason: required|in:administrative,customer_not_received
  - admin_notes: nullable|string
```

#### رفض طلب الإلغاء
```
POST /api/v1/dashboard/order_cancellation_requests/{request_id}/reject
Body:
  - admin_notes: nullable|string
```

## خطوات التثبيت

1. **تشغيل الهجرات:**
```bash
php artisan migrate
```

2. **تشغيل السيدرز:**
```bash
php artisan db:seed --class=OrderCancellationRequestPermissionsSeeder
# أو تشغيل جميع السيدرز
php artisan db:seed
```

3. **مسح الكاش:**
```bash
php artisan route:clear
php artisan config:clear
php artisan cache:clear
```

## مثال على سير العمل

### جانب المستخدم:
1. المستخدم يضع طلب
2. المستخدم يغير رأيه ويطلب الإلغاء
3. النظام ينشئ طلب إلغاء بحالة "معلق"
4. المستخدم يستلم إشعار عندما تراجع الإدارة الطلب

### جانب الإدارة:
1. الإدارة تعرض جميع طلبات الإلغاء المعلقة
2. الإدارة تراجع الطلب وتفاصيل الطلب
3. الإدارة تقرر الموافقة أو الرفض:
   
   **إذا وافقت:**
   - تختار سبب الإلغاء (سبب إداري أو عدم استلام الزبون)
   - تضيف ملاحظات إدارية اختيارية
   - النظام يلغي الطلب، يرجع المبلغ، يرجع المنتجات للمخزون
   - المستخدم يستلم إشعار الموافقة مع تفاصيل الإرجاع
   
   **إذا رفضت:**
   - تضيف ملاحظات إدارية اختيارية توضح السبب
   - الطلب يستمر بحالته الحالية
   - المستخدم يستلم إشعار الرفض

## المنطق التجاري

### حساب الإرجاع عند الموافقة:
- **سبب إداري:** المستخدم يستلم إرجاع كامل بما فيه رسوم الشحن
- **عدم استلام الزبون:** المستخدم يستلم إرجاع بدون رسوم الشحن

### إدارة المخزون:
- المنتجات ترجع للمخزون فقط عند الموافقة على الإلغاء
- كميات المنتجات تُرجع إلى البدائل (variants)

### تدفق الحالة:
```
طلب الإلغاء: معلق → موافق عليه (الطلب ملغى) → الدفع مُرجع
                    → مرفوض (الطلب يستمر)
```

## ملاحظات

1. **طلب واحد لكل طلب:** طلب إلغاء معلق واحد فقط مسموح لكل طلب لتجنب الالتباس
2. **فحص حالة الطلب:** النظام يتحقق من أن الطلب يمكن إلغاؤه قبل إنشاء طلب الإلغاء
3. **سجل التدقيق:** النظام يتتبع من راجع الطلب ومتى
4. **الإشعارات:** كل من الموافقة والرفض يرسلان إشعارات للمستخدم
5. **الصلاحيات:** المدراء يحتاجون إلى صلاحيات مناسبة لعرض وإدارة طلبات الإلغاء

## رسائل الخطأ

جميع رسائل الخطأ مترجمة بالعربية والإنجليزية:
- لا يمكن طلب إلغاء هذا الطلب
- يوجد طلب إلغاء معلق بالفعل
- طلب الإلغاء غير معلق
- أخطاء الصلاحيات

## نجاح!

نظام طلبات إلغاء الطلبات الكامل جاهز الآن. المستخدمون يمكنهم طلب الإلغاء، والإدارة يمكنها مراجعة وإدارة هذه الطلبات مع التحكم الكامل في عملية الإلغاء ومنطق الإرجاع.
